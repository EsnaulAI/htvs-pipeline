configfile: 'config/config.yaml'

USE_MMSEQS = config["evolution"].get("use_mmseqs", False)

# --- REGLA MAESTRA GLOBAL ---
rule all:
    input:
        "results/module1/candidate_ranking.csv",
        "results/module1/coevolution_profile.png",
        "results/module1/config_updated.flag",
        "results/module1/msa_qc_report.csv",
        "results/module1/target_prepared.pdbqt",
        "results/module1/view_scene.cxc",
        "results/module2/qc_report.csv",
        "results/module2/preparation_done.flag"

# --- MÓDULO 1: INTELIGENCIA BIOLÓGICA ---

rule fetch_clean_pdb:
    conda:
        "../environment.yaml"
    output:
        pdb=config["structure"]["clean_pdb"],
        fasta="results/module1/target.fasta"
    params:
        pdb_id=config["structure"]["pdb_id"],
        chain=config["structure"]["chain_id"]
    script:
        'scripts/module1_prep_structure.py'

# [cite_start]MEJORA: Aumentamos a 2000 hits y usamos base de datos 'nr' [cite: 4]
if not USE_MMSEQS:
    rule run_blast:
        conda:
            "envs/mmseqs.yaml"
        input: 
            fasta="results/module1/target.fasta"
        output: 
            xml="results/module1/blast_results.xml",
            fasta_homologs=config["evolution"]["unaligned_homologs"],
            method_log="results/module1/homolog_method.log"
        params:
            n_hits=2000,       # Aumentado para potencia estadística en DCA
            e_val=0.001,
            db="nr"            # Base de datos masiva (Non-Redundant)
        script: 
            'scripts/module1_run_blast.py'
else:
    rule run_mmseqs:
        input:
            fasta="results/module1/target.fasta"
        output:
            fasta_homologs=config["evolution"]["unaligned_homologs"],
            method_log="results/module1/homolog_method.log"
        threads: 4
        conda:
            "envs/mmseqs.yaml"
        script:
            'scripts/module1_run_mmseqs.py'

rule parse_and_align:
    conda:
        "envs/mafft.yaml"
    input: 
        homologs=config["evolution"]["unaligned_homologs"],
        original_fasta="results/module1/target.fasta"
    output: 
        fasta_msa=config["evolution"]["msa_file"]
    threads: 4
    conda:
        "envs/mafft.yaml"
    script:
        'scripts/module1_parse_and_align.py'

rule msa_qc:
    conda:
        "../environment.yaml"
    input:
        msa=config["evolution"]["msa_file"]
    output:
        report=config["evolution"]["msa_qc_report"]
    script:
        'scripts/module1_msa_qc.py'

rule map_conservation:
    conda:
        "../environment.yaml"
    input:
        pdb=config["structure"]["clean_pdb"],
        msa=config["evolution"]["msa_file"],
        qc_report=config["evolution"]["msa_qc_report"],
    output:
        pdb_conserved=config["evolution"]["conservation_pdb"],
        pdb_msa_map=config["evolution"]["pdb_msa_map"],
    script: 'scripts/module1_map_entropy.py'

rule run_pydca:
    conda:
        "envs/pydca.yaml"
    input:
        msa=config["evolution"]["msa_file"],
        pdb_msa_map=config["evolution"]["pdb_msa_map"]
    output:
        plot="results/module1/dca_distribution.png",
        report="results/module1/dca_top_contacts.csv"
    params: target_res=config["structure"]["target_residue"]
    conda:
        "envs/pydca.yaml"
    script: 'scripts/module1_pydca.py'

rule run_coevolution_mi:
    input:
        msa=config["evolution"]["msa_file"],
        pdb_msa_map=config["evolution"]["pdb_msa_map"]
    output: plot="results/module1/coevolution_profile.png"
    params:
        target_res=config["structure"]["target_residue"]
    script: 'scripts/module1_coevolution_mi.py'

rule run_network_analysis:
    conda:
        "../environment.yaml"
    input: pdb=config["evolution"]["conservation_pdb"]
    output: report="results/module1/network_report.txt"
    params:
        target_res=config["structure"]["target_residue"],
        chain=config["structure"]["chain_id"]
    script: 'scripts/module1_network_analysis.py'

rule run_nma:
    conda:
        "../environment.yaml"
    input: pdb=config["evolution"]["conservation_pdb"]
    output: plot="results/module1/nma_mobility_profile.png"
    params:
        target_res=config["structure"]["target_residue"],
        chain=config["structure"]["chain_id"]
    script: 'scripts/module1_nma_check.py'

rule check_druggability:
    conda:
        "../environment.yaml"
    input: pdb=config["structure"]["clean_pdb"]
    output: report="results/module1/druggability_report.txt"
    params:
        chain=config["structure"]["chain_id"],
        target_res=config["structure"]["target_residue"]
    script: 'scripts/module1_check_druggability.py'

rule run_fpocket:
    conda:
        "envs/fpocket.yaml"
    input: pdb=config["structure"]["clean_pdb"]
    output: info="results/module1/pockets/target_clean_info.txt"
    conda:
        "envs/fpocket.yaml"
    shell:
        """
        fpocket -f {input.pdb}
        mkdir -p results/module1/pockets
        mv results/module1/target_clean_out/target_clean_info.txt {output.info}
        rm -rf results/module1/target_clean_out
        """

rule prepare_receptor_phys:
    conda:
        "envs/openbabel.yaml"
    input: pdb=config["structure"]["clean_pdb"]
    output: pdbqt="results/module1/target_prepared.pdbqt"
    conda:
        "envs/openbabel.yaml"
    shell:
        """
        set -euo pipefail
        mkdir -p logs
        log_file="logs/prepare_receptor_phys.log"
        if ! obabel {input.pdb} -O {output.pdbqt} -xr --partialcharge gasteiger -p 7.4; then
            echo "[prepare_receptor_phys] ERROR: obabel failed for {input.pdb}" | tee -a "$log_file" >&2
            exit 1
        fi
        if [ ! -s {output.pdbqt} ]; then
            echo "[prepare_receptor_phys] ERROR: PDBQT output missing or empty: {output.pdbqt}" | tee -a "$log_file" >&2
            exit 1
        fi
        """

rule discover_best_candidate:
    conda:
        "../environment.yaml"
    input:
        pdb=config["evolution"]["conservation_pdb"],
        pockets="results/module1/pockets/target_clean_info.txt"
    output: csv="results/module1/candidate_ranking.csv"
    params: chain=config["structure"]["chain_id"]
    script: 'scripts/module1_discover_best_target.py'

rule update_target_config:
    conda:
        "../environment.yaml"
    input:
        csv="results/module1/candidate_ranking.csv",
        pdb=config["structure"]["clean_pdb"]
    output: touch("results/module1/config_updated.flag")
    params: chain=config["structure"]["chain_id"]
    script: 'scripts/bridge_update_config.py'

rule generate_viz:
    conda:
        "../environment.yaml"
    input: pdb=config["evolution"]["conservation_pdb"]
    output: cxc="results/module1/view_scene.cxc"
    params:
        target_res=config["structure"]["target_residue"],
        chain=config["structure"]["chain_id"]
    script: 'scripts/generate_chimerax_scene.py'

# --- MÓDULO 2: QUIMIOINFORMÁTICA ---


# 1. Minería de Datos (API ChEMBL) + Inyección de Controles
rule fetch_library:
    conda:
        "../environment.yaml"
    output: smi=config["chemistry"]["raw_library"]
    script: 'scripts/fetch_chembl_drugs.py'

# 2. Filtrado Farmacológico (Reglas eNTRy)
rule filter_ligands:
    conda:
        "envs/rdkit.yaml"
    input: smi=config["chemistry"]["raw_library"]
    output:
        filtered=config["chemistry"]["filtered_library"],
        report="results/module2/filtering_report.csv",
        dedup="results/module2/library_dedup.smi"
    params:
        mw=config["chemistry"]["filters"]["mw_max"],
        logp=config["chemistry"]["filters"]["logp_max"],
        amine=config["chemistry"]["filters"]["must_have_amine"]
    script: 'scripts/module2_filter_entry.py'

# 2b. Control de Calidad de Propiedades
rule qc_properties:
    conda:
        "envs/rdkit.yaml"
    input: smi=config["chemistry"]["filtered_library"]
    output:
        report="results/module2/qc_report.csv"
    script: 'scripts/module2_qc_properties.py'

# 3. Preparación 3D Paralela
rule prepare_ligands_3d:
    conda:
        "envs/rdkit.yaml"
    input:
        smi=config["chemistry"]["filtered_library"],
        qc_report="results/module2/qc_report.csv"
# 3. Enumeración de protómeros (pH 7.4 ± 1)
rule enumerate_protomers:
    conda:
        "envs/rdkit.yaml"
    input: smi="results/module2/library_dedup.smi"
    output:
        enumerated="results/module2/library_enumerated.smi"
    script: 'scripts/module2_enumerate_protomers.py'

# 4. Preparación 3D Paralela
rule prepare_ligands_3d:
    conda:
        "envs/rdkit.yaml"
    input: smi="results/module2/library_enumerated.smi"
    output: touch("results/module2/preparation_done.flag")
    params: out_dir=config["chemistry"]["prepared_dir"]
    threads: 4
    script: 'scripts/module2_prep_3d.py'

rule export_ligands_pdbqt:
    conda:
        "envs/openbabel.yaml"
    input:
        prepared_done="results/module2/preparation_done.flag",
        prepared_dir=config["chemistry"]["prepared_dir"]
    output:
        pdbqt_dir=directory("results/module2/ligands_pdbqt")
    script: 'scripts/module2_export_pdbqt.py'
